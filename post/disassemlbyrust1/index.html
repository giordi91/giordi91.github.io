<!DOCTYPE html>
<html lang="en-US">

<head>
<meta charset="utf-8" />
<meta name="author" content="Marco Giordano" />
<meta name="description" content="A-programmer&#39;s-cave" />
<meta name="keywords" content="" />
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.47.1" />

<link rel="canonical" href="/post/disassemlbyrust1/">
<base href="/" />
<meta property="og:title" content="Rust Disassembly: part 1" />
<meta property="og:description" content="What do some Rust features compile to? Intro I have been starting to have a look at Rust lately, mostly because WASM is growing on me and Rust has the best tool in class for it, or so I am told. I am eager to find out by myself.
Rust comes with several new idioms and structures in the language I am not used to, and being a performance enthusiast, I always get interested in what such constructs translate to." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/disassemlbyrust1/" /><meta property="article:published_time" content="2020-05-23T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2020-05-23T00:00:00&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Rust Disassembly: part 1"/>
<meta name="twitter:description" content="What do some Rust features compile to? Intro I have been starting to have a look at Rust lately, mostly because WASM is growing on me and Rust has the best tool in class for it, or so I am told. I am eager to find out by myself.
Rust comes with several new idioms and structures in the language I am not used to, and being a performance enthusiast, I always get interested in what such constructs translate to."/>



<meta itemprop="name" content="Rust Disassembly: part 1">
<meta itemprop="description" content="What do some Rust features compile to? Intro I have been starting to have a look at Rust lately, mostly because WASM is growing on me and Rust has the best tool in class for it, or so I am told. I am eager to find out by myself.
Rust comes with several new idioms and structures in the language I am not used to, and being a performance enthusiast, I always get interested in what such constructs translate to.">


<meta itemprop="datePublished" content="2020-05-23T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2020-05-23T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1544">



<meta itemprop="keywords" content="rust,disassembly," />


<script async src="/dist/main.js"></script>
<link rel="stylesheet" href="dist/main.css" />
<style type="text/css">
body {
  background-color: {
     {
      .Param 'colors.background';
    }
  }
  color: {
     {
      .Param 'colors.text';
    }
  }
}

a {
  color: {
     {
      .Param 'colors.link';
    }
  }
}

pre {
  background: {
     {
      .Param 'colors.code-quote-bg';
    }
  }
  border: 1px solid {
     {
      .Param 'colors.text';
    }
  }
  border-radius: 5px;
}

code {
  background: {
     {
      .Param 'colors.code-quote-bg';
    }
  }
}

blockquote {
  background: {
     {
      .Param 'colors.code-quote-bg';
    }
  }
  border-left: 3px solid {
     {
      .Param 'colors.text';
    }
  }
}

table {
  margin: 1em auto;
  border-collapse: collapse;
}

table,
th,
td {
  border: 1px solid {
     {
      .Param 'colors.text';
    }
  }
}

th {
  background: {
     {
      .Param 'colors.text';
    }
  }
  color: {
     {
      .Param 'colors.background';
    }
  }
}

.siteTitle a {
  color: {
     {
      .Param 'colors.main';
    }
  }
}

.post .content h1 {
  color: {
     {
      .Param 'colors.main';
    }
  }
}
.post .content h2 {
  color: {
     {
      .Param 'colors.main';
    }
  }
}
.post .content h3 {
  color: {
     {
      .Param 'colors.main';
    }
  }
}
.post .content h4 {
  color: {
     {
      .Param 'colors.main';
    }
  }
}
.post .content h5 {
  color: {
     {
      .Param 'colors.main';
    }
  }
}
.post .content h6 {
  color: {
     {
      .Param 'colors.main';
    }
  }
}
.post .content a:hover {
  color: {
     {
      .Param 'colors.main';
    }
  }
}
.social-link:hover {
  color: {
     {
      .Param 'colors.main';
    }
  }
}
.nav-item-title:hover {
  color: {
     {
      .Param 'colors.main';
    }
  }
}
.tag a:hover {
  color: {
     {
      .Param 'colors.main';
    }
  }
}
.copyright {
  color: {
     {
      .Param 'colors.copyright';
    }
  }
}
.poweredby {
  color: {
     {
      .Param 'colors.copyright';
    }
  }
}
.poweredby a {
  color: {
     {
      .Param 'colors.copyright';
    }
  }
}
.post-preview .title a {
  color: {
     {
      .Param 'colors.main';
    }
  }
}
.content-item a:hover {
  text-decoration: underline;
  color: {
     {
      .Param 'colors.main';
    }
  }
}
.post-list .title {
  color: {
     {
      .Param 'colors.main';
    }
  }
}
.rmore {
  color: {
     {
      .Param 'colors.main';
    }
  }
}
.terms .term a:hover {
  text-decoration: underline;
  color: {
     {
      .Param 'colors.main';
    }
  }
}

</style>



<title>


     Rust Disassembly: part 1 

</title>

</head>


<body>
<div class="main">
    <header>

        <div class="header-bar">

            <nav>
                <div class="siteTitle">
                    <a href="/">A-programmer&#39;s-cave</a>
                </div> 
                
                
                <a class="nav-item active" href="/post/"><div class="nav-item-title">Posts</div></a>
                
                <a class="nav-item" href="/tags/"><div class="nav-item-title">Tags</div></a>
                

            </nav>
        </div>

        
<div class="social-links-header">

  
  <a href="mailto:myemail"><div class="social-link">email</div></a>
  

  
  <a href="https://github.com/giordi91" target="_blank"><div class="social-link">gh</div></a>
  

  

  
  <a href="https://twitter.com/MGDev91" target="_blank"><div class="social-link">twtr</div></a>
  

  

  <a href="pages/bind.html" target="_blank"><div class="social-link">TheBinder</div></a>

</div>

        <script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
         extensions: ["AMSmath.js", "AMSsymbols.js"] }
  }
  });
  MathJax.Hub.Queue(function() {
    
    
    
    var all = MathJax.Hub.getAllJax(), i;
    for(i = 0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });

  MathJax.Hub.Config({
  
  TeX: { equationNumbers: { autoNumber: "AMS" } }
  });
</script>

		
    </header>


<article class="post">
    <h1 class="title"> Rust Disassembly: part 1 </h1>
		
            
		        Table of contents:
            
		    <nav id="TableOfContents">
<ul>
<li><a href="#intro">Intro</a></li>
<li><a href="#i128">i128</a></li>
<li><a href="#destructuring">Destructuring</a></li>
<li><a href="#arrays">Arrays</a></li>
<li><a href="#loops">Loops</a></li>
</ul>
</nav>
		
    <div class="content"> 

<p style="background:gray;padding: 1em;">
What do some Rust features compile to?
</p>

<p><img src="../images/22_rust1/logo.png" alt="intro" />
<br><br></p>

<h1 id="intro">Intro</h1>

<p>I have been starting to have a look at Rust lately, mostly because WASM is growing on me and Rust has
the best tool in class for it, or so I am told. I am eager to find out by myself.</p>

<p>Rust comes with several new idioms and structures in the language I am not used to, and being a performance enthusiast, I always get interested in what such constructs translate to.</p>

<p>I put together some tests that I will be discussing below, here the link to a compiler explorer
<a href="https://godbolt.org/z/Xbf-7u" target="_blank">compiler explorer</a>

page.</p>

<h1 id="i128">i128</h1>

<p>One of the first things I came across was the i128 datatype, allowing to stuff up to 128 bits in an integer, I was curious
to see how that was actually handled:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#999;font-style:italic">// testing i128
</span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">add128</span>(a<span style="color:#666"> </span>: <span style="color:#447fcf;text-decoration:underline">i128</span>,<span style="color:#666"> </span>b: <span style="color:#447fcf;text-decoration:underline">i128</span>)<span style="color:#666"> </span>-&gt; <span style="color:#447fcf;text-decoration:underline">i128</span><span style="color:#666"> </span>{<span style="color:#666">
</span><span style="color:#666">    </span>a<span style="color:#666"> </span>+<span style="color:#666"> </span>b<span style="color:#666">
</span><span style="color:#666"></span>}<span style="color:#666">
</span><span style="color:#666">
</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">mul128</span>(a<span style="color:#666"> </span>: <span style="color:#447fcf;text-decoration:underline">i128</span>,<span style="color:#666"> </span>b: <span style="color:#447fcf;text-decoration:underline">i128</span>)<span style="color:#666"> </span>-&gt; <span style="color:#447fcf;text-decoration:underline">i128</span><span style="color:#666"> </span>{<span style="color:#666">
</span><span style="color:#666">    </span>a<span style="color:#666"> </span>*<span style="color:#666"> </span>b<span style="color:#666">
</span><span style="color:#666"></span>}<span style="color:#666">
</span><span style="color:#666"></span></code></pre></div>
<p>Which translates to:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">example:<span style="color:#a61717;background-color:#e3d2d2">:</span>add128:
    <span style="color:#447fcf">mov</span>     <span style="color:#40ffff">rax</span>, <span style="color:#40ffff">rdi</span>
    <span style="color:#447fcf">add</span>     <span style="color:#40ffff">rax</span>, <span style="color:#40ffff">rdx</span>
    <span style="color:#447fcf">adc</span>     <span style="color:#40ffff">rsi</span>, <span style="color:#40ffff">rcx</span>
    <span style="color:#447fcf">mov</span>     <span style="color:#40ffff">rdx</span>, <span style="color:#40ffff">rsi</span>
    <span style="color:#447fcf">ret</span>

example:<span style="color:#a61717;background-color:#e3d2d2">:</span>mul128:
    <span style="color:#447fcf">mov</span>     <span style="color:#40ffff">r8</span>, <span style="color:#40ffff">rdx</span>
    <span style="color:#447fcf">mov</span>     <span style="color:#40ffff">rax</span>, <span style="color:#40ffff">rdx</span>
    <span style="color:#447fcf">mul</span>     <span style="color:#40ffff">rdi</span>
    <span style="color:#447fcf">imul</span>    <span style="color:#40ffff">rsi</span>, <span style="color:#40ffff">r8</span>
    <span style="color:#447fcf">add</span>     <span style="color:#40ffff">rdx</span>, <span style="color:#40ffff">rsi</span>
    <span style="color:#447fcf">imul</span>    <span style="color:#40ffff">rcx</span>, <span style="color:#40ffff">rdi</span>
    <span style="color:#447fcf">add</span>     <span style="color:#40ffff">rdx</span>, <span style="color:#40ffff">rcx</span>
    <span style="color:#447fcf">ret</span></code></pre></div>
<p>As most of you probably expected the i128 bits are implemented in software, it becomes especially clear in the addition where
we see a first addition followed by an <code>adc</code> instruction, which takes care of adding the carry flag as well in case it was set.
Pretty cool!</p>

<h1 id="destructuring">Destructuring</h1>

<p>The second feature I came across is called destructuring; it is one way to access data of a tuple, mind you a tuple can have heterogeneous data types in it, that is an important detail as we will see in a second. Here an example of destructuring.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#999;font-style:italic">// destructuring
</span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">destructuring</span>(a<span style="color:#666"> </span>: (<span style="color:#6ab825;font-weight:bold">f32</span>,<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">f32</span>,<span style="color:#6ab825;font-weight:bold">f32</span>))<span style="color:#666"> </span>-&gt; <span style="color:#6ab825;font-weight:bold">f32</span> {<span style="color:#666">
</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span>(_,_,z)<span style="color:#666"> </span>=<span style="color:#666"> </span>a;<span style="color:#666">
</span><span style="color:#666">        </span>z<span style="color:#666">
</span><span style="color:#666"></span>}<span style="color:#666">
</span><span style="color:#666">
</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">destructuring2</span>(a<span style="color:#666"> </span>: (<span style="color:#6ab825;font-weight:bold">f32</span>,<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">f32</span>,<span style="color:#6ab825;font-weight:bold">f32</span>))<span style="color:#666"> </span>-&gt; <span style="color:#6ab825;font-weight:bold">f32</span> {<span style="color:#666">
</span><span style="color:#666">    </span>a.<span style="color:#3677a9">2</span><span style="color:#666">
</span><span style="color:#666"></span>}<span style="color:#666">
</span><span style="color:#666"></span></code></pre></div>
<p>Here the resulting asm:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">example:<span style="color:#a61717;background-color:#e3d2d2">:</span>destructuring:
    <span style="color:#447fcf">movss</span>   <span style="color:#40ffff">xmm0</span>, <span style="color:#40ffff">dword</span> <span style="color:#40ffff">ptr</span> [<span style="color:#40ffff">rdi</span> <span style="color:#a61717;background-color:#e3d2d2">+</span> <span style="color:#3677a9">8</span>]
    <span style="color:#447fcf">ret</span></code></pre></div>
<p>The compiler has no problem understanding what the user wants to extract and can optimize all the destructuring that
is not needed. The compiler is merely shifting the pointer to where we wish to read: <code>[rdi + 8]</code> , if we decided to access the second element we would see : <code>[rdi + 4]</code>.</p>

<p>The destructuring2 two function generates exactly the same code. Interingly enough we can&rsquo;t access an elment by an index variable, something like this is not legal:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">destructuring2</span>(a<span style="color:#666"> </span>: (<span style="color:#6ab825;font-weight:bold">f32</span>,<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">f32</span>,<span style="color:#6ab825;font-weight:bold">f32</span>),<span style="color:#666"> </span>b: <span style="color:#6ab825;font-weight:bold">usize</span>)<span style="color:#666"> </span>-&gt; <span style="color:#6ab825;font-weight:bold">f32</span> {<span style="color:#666">
</span><span style="color:#666">    </span>a.b<span style="color:#666">
</span><span style="color:#666"></span>}<span style="color:#666">
</span><span style="color:#666"></span></code></pre></div>
<p>It would be ambiguous for the language grammar to begin with, and the compiler would not be able to see what value you wish
to unpack ahead of time,giving it troubles with touble heterogeneous types.</p>

<h1 id="arrays">Arrays</h1>

<p>Next on the list is arrays.</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#999;font-style:italic">//arrays
</span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">array1</span>()<span style="color:#666"> </span>-&gt; <span style="color:#6ab825;font-weight:bold">i32</span> {<span style="color:#666">
</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span>a<span style="color:#666"> </span>=<span style="color:#666"> </span>[<span style="color:#3677a9">1</span>,<span style="color:#3677a9">2</span>,<span style="color:#3677a9">3</span>,<span style="color:#3677a9">4</span>,<span style="color:#3677a9">5</span>];<span style="color:#666">
</span><span style="color:#666">    </span>a[<span style="color:#3677a9">2</span>]<span style="color:#666">
</span><span style="color:#666"></span>}<span style="color:#666">
</span><span style="color:#666">
</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">array2</span>(<span style="color:#666"> </span>a: <span style="color:#6ab825">&amp;</span>[<span style="color:#6ab825;font-weight:bold">i32</span>;<span style="color:#3677a9">5</span>])<span style="color:#666"> </span>-&gt; <span style="color:#6ab825;font-weight:bold">i32</span> {<span style="color:#666">
</span><span style="color:#666">    </span>a[<span style="color:#3677a9">4</span>]<span style="color:#666">
</span><span style="color:#666"></span>}<span style="color:#666">
</span><span style="color:#666">
</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">array3</span>(<span style="color:#666"> </span>a: <span style="color:#6ab825">&amp;</span>[<span style="color:#6ab825;font-weight:bold">i32</span>;<span style="color:#3677a9">5</span>],<span style="color:#666"> </span>b: <span style="color:#6ab825;font-weight:bold">usize</span>)<span style="color:#666"> </span>-&gt; <span style="color:#6ab825;font-weight:bold">i32</span> {<span style="color:#666">
</span><span style="color:#666">    </span>a[b]<span style="color:#666">
</span><span style="color:#666"></span>}<span style="color:#666">
</span><span style="color:#666"></span></code></pre></div>
<p>Here there are some different examples of array usage. In the first and second, the compiler is able to see what the user wants
to do and is able to optimize the heck out of it, here the generated assembly for the first two tests:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">example:<span style="color:#a61717;background-color:#e3d2d2">:</span>array1:
    <span style="color:#447fcf">mov</span>     <span style="color:#40ffff">eax</span>, <span style="color:#3677a9">3</span>
    <span style="color:#447fcf">ret</span>

example:<span style="color:#a61717;background-color:#e3d2d2">:</span>array2:
    <span style="color:#447fcf">mov</span>     <span style="color:#40ffff">eax</span>, <span style="color:#40ffff">dword</span> <span style="color:#40ffff">ptr</span> [<span style="color:#40ffff">rdi</span> <span style="color:#a61717;background-color:#e3d2d2">+</span> <span style="color:#3677a9">16</span>]
    <span style="color:#447fcf">ret</span></code></pre></div>
<p>As we can see, in the first case, the compiler nukes the array entirely and returns the wanted value as expected, the second examples
show a simple read by an offset and return. Pretty straight forward, but what if we use an index the compiler does not know at compile time like in the 3rd example?</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">example:<span style="color:#a61717;background-color:#e3d2d2">:</span>array3:
    <span style="color:#447fcf">push</span>    <span style="color:#40ffff">rax</span>
    <span style="color:#447fcf">cmp</span>     <span style="color:#40ffff">rsi</span>, <span style="color:#3677a9">4</span>
    <span style="color:#447fcf">ja</span>      <span style="color:#40ffff">.LBB5_2</span>
    <span style="color:#447fcf">mov</span>     <span style="color:#40ffff">eax</span>, <span style="color:#40ffff">dword</span> <span style="color:#40ffff">ptr</span> [<span style="color:#40ffff">rdi</span> <span style="color:#a61717;background-color:#e3d2d2">+</span> <span style="color:#3677a9">4</span>*<span style="color:#40ffff">rsi</span>]
    <span style="color:#447fcf">pop</span>     <span style="color:#40ffff">rcx</span>
    <span style="color:#447fcf">ret</span>
.LBB5_2:
    <span style="color:#447fcf">lea</span>     <span style="color:#40ffff">rdi</span>, [<span style="color:#40ffff">rip</span> <span style="color:#a61717;background-color:#e3d2d2">+</span> <span style="color:#40ffff">.L__unnamed_1</span>]
    <span style="color:#447fcf">mov</span>     <span style="color:#40ffff">edx</span>, <span style="color:#3677a9">5</span>
    <span style="color:#447fcf">call</span>    <span style="color:#40ffff">qword</span> <span style="color:#40ffff">ptr</span> [<span style="color:#40ffff">rip</span> <span style="color:#a61717;background-color:#e3d2d2">+</span> <span style="color:#40ffff">core</span>::<span style="color:#40ffff">panicking</span>::<span style="color:#40ffff">panic_bounds_check@GOTPCREL</span>]
    <span style="color:#447fcf">ud2</span></code></pre></div>
<p>Ouch! Here we can see Rust memory safety coming into play. The compiler is not able to make sure at compile time that the memory access will be within the bounds of the array, as such we can first see a comparison with the array size (or better, to the maximum valid index which is size -1):</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">    <span style="color:#447fcf">cmp</span>     <span style="color:#40ffff">rsi</span>, <span style="color:#3677a9">4</span></code></pre></div>
<p>Which is not an expensive operation per se, but what it follows might be:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">    <span style="color:#447fcf">ja</span>      <span style="color:#40ffff">.LBB5_2</span></code></pre></div>
<p>In the case our index is higher the the biggest valid index we jump straight to panic land:</p>

<pre><code>.LBB5_2:
    lea     rdi, [rip + .L__unnamed_1]
    mov     edx, 5
    call    qword ptr [rip + core::panicking::panic_bounds_check@GOTPCREL]
    ud2
</code></pre>

<p>First of all, let me say I love how it is literally called panic, second is the first time I meet the <code>ud2</code> instruction,
very interesting! The ud2instruction generates an invalid instruction, and we have it after the panic mode. Not sure what exactly is needed for, maybe if for any reason panic mode doesn ot terminate the program such instruction will trigger a trap at hardware level?</p>

<p style="background:gray;padding: 1em;">
About the ud2 instruction</p>

<p style="background:gray;padding: 1em;">
After the publishing of the blog post, <a href="https://twitter.com/pmjordan" target="_blank">Phil Dennis-Jordan</a>
 sparked an interesting discusission about what the source of ud2 could be.
That lead me in the end to ask the compiler team in the Rust discord about it. 
The user "Hanna" pointed me out to the relevant behaviour and 
<a href="https://github.com/rust-lang/rust/pull/45920" target="_blank">PR</a>

implementing it.

The TLDR is that, the rust compiler flips an options in LLVM to insert that instruction everywhere there is unreachable code to make 100% sure such code could not fall through by using hardware traps.
</p>

<p>At this point, a c/c++ programmer might think: &ldquo;oh well we rust is too slow, goodbye!&rdquo; Hold on for a second, let us not be too hasty, shall we? Sure accessing a random index might be sub-obtimal, but what if we are iterating?</p>

<h1 id="loops">Loops</h1>

<p>Here our first loop example:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">loop1</span>(<span style="color:#666"> </span>a: <span style="color:#6ab825">&amp;</span>[<span style="color:#6ab825;font-weight:bold">i32</span>;<span style="color:#3677a9">5</span>],<span style="color:#666"> </span>b: <span style="color:#6ab825;font-weight:bold">usize</span>)<span style="color:#666"> </span>-&gt; <span style="color:#6ab825;font-weight:bold">i32</span> {<span style="color:#666">
</span><span style="color:#666">
</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">mut</span><span style="color:#666"> </span>idx: <span style="color:#6ab825;font-weight:bold">usize</span> =<span style="color:#666"> </span><span style="color:#3677a9">0</span>;<span style="color:#666">
</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">mut</span><span style="color:#666"> </span>total<span style="color:#666"> </span>: <span style="color:#6ab825;font-weight:bold">i32</span> =<span style="color:#3677a9">0</span>;<span style="color:#666">
</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">while</span><span style="color:#666"> </span>idx<span style="color:#666"> </span>&lt;<span style="color:#666"> </span>b<span style="color:#666">
</span><span style="color:#666">    </span>{<span style="color:#666">
</span><span style="color:#666">        </span>total<span style="color:#666"> </span>=<span style="color:#666"> </span>total<span style="color:#666"> </span>+<span style="color:#666"> </span>a[idx];<span style="color:#666">
</span><span style="color:#666">        </span>idx+=<span style="color:#3677a9">1</span>;<span style="color:#666">
</span><span style="color:#666">    </span>}<span style="color:#666">
</span><span style="color:#666">    </span>total<span style="color:#666">
</span><span style="color:#666"></span>}<span style="color:#666">
</span><span style="color:#666"></span></code></pre></div>
<p>In the above code, we are merely doing a reduce of the provided array, but we are passing the maximum iteration index to the function, this might be for several reasons like for example iterating a subset of the array.</p>

<p>Here the result</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">example:<span style="color:#a61717;background-color:#e3d2d2">:</span>loop1:
    <span style="color:#447fcf">push</span>    <span style="color:#40ffff">rax</span>
    <span style="color:#447fcf">test</span>    <span style="color:#40ffff">rsi</span>, <span style="color:#40ffff">rsi</span>
    <span style="color:#447fcf">je</span>      <span style="color:#40ffff">.LBB6_1</span>
    <span style="color:#447fcf">mov</span>     <span style="color:#40ffff">eax</span>, <span style="color:#40ffff">dword</span> <span style="color:#40ffff">ptr</span> [<span style="color:#40ffff">rdi</span>]
    <span style="color:#447fcf">cmp</span>     <span style="color:#40ffff">rsi</span>, <span style="color:#3677a9">1</span>
    <span style="color:#447fcf">je</span>      <span style="color:#40ffff">.LBB6_2</span>
    <span style="color:#447fcf">add</span>     <span style="color:#40ffff">eax</span>, <span style="color:#40ffff">dword</span> <span style="color:#40ffff">ptr</span> [<span style="color:#40ffff">rdi</span> <span style="color:#a61717;background-color:#e3d2d2">+</span> <span style="color:#3677a9">4</span>]
    <span style="color:#447fcf">cmp</span>     <span style="color:#40ffff">rsi</span>, <span style="color:#3677a9">2</span>
    <span style="color:#447fcf">je</span>      <span style="color:#40ffff">.LBB6_2</span>
    <span style="color:#447fcf">add</span>     <span style="color:#40ffff">eax</span>, <span style="color:#40ffff">dword</span> <span style="color:#40ffff">ptr</span> [<span style="color:#40ffff">rdi</span> <span style="color:#a61717;background-color:#e3d2d2">+</span> <span style="color:#3677a9">8</span>]
    <span style="color:#447fcf">cmp</span>     <span style="color:#40ffff">rsi</span>, <span style="color:#3677a9">3</span>
    <span style="color:#447fcf">je</span>      <span style="color:#40ffff">.LBB6_2</span>
    <span style="color:#447fcf">add</span>     <span style="color:#40ffff">eax</span>, <span style="color:#40ffff">dword</span> <span style="color:#40ffff">ptr</span> [<span style="color:#40ffff">rdi</span> <span style="color:#a61717;background-color:#e3d2d2">+</span> <span style="color:#3677a9">12</span>]
    <span style="color:#447fcf">cmp</span>     <span style="color:#40ffff">rsi</span>, <span style="color:#3677a9">4</span>
    <span style="color:#447fcf">je</span>      <span style="color:#40ffff">.LBB6_2</span>
    <span style="color:#447fcf">cmp</span>     <span style="color:#40ffff">rsi</span>, <span style="color:#3677a9">5</span>
    <span style="color:#447fcf">jne</span>     <span style="color:#40ffff">.LBB6_9</span>
    <span style="color:#447fcf">add</span>     <span style="color:#40ffff">eax</span>, <span style="color:#40ffff">dword</span> <span style="color:#40ffff">ptr</span> [<span style="color:#40ffff">rdi</span> <span style="color:#a61717;background-color:#e3d2d2">+</span> <span style="color:#3677a9">16</span>]
    <span style="color:#447fcf">pop</span>     <span style="color:#40ffff">rcx</span>
    <span style="color:#447fcf">ret</span>
.LBB6_1:
    <span style="color:#447fcf">xor</span>     <span style="color:#40ffff">eax</span>, <span style="color:#40ffff">eax</span>
.LBB6_2:
    <span style="color:#447fcf">pop</span>     <span style="color:#40ffff">rcx</span>
    <span style="color:#447fcf">ret</span>
.LBB6_9:
    <span style="color:#447fcf">lea</span>     <span style="color:#40ffff">rdi</span>, [<span style="color:#40ffff">rip</span> <span style="color:#a61717;background-color:#e3d2d2">+</span> <span style="color:#40ffff">.L__unnamed_2</span>]
    <span style="color:#447fcf">mov</span>     <span style="color:#40ffff">esi</span>, <span style="color:#3677a9">5</span>
    <span style="color:#447fcf">mov</span>     <span style="color:#40ffff">edx</span>, <span style="color:#3677a9">5</span>
    <span style="color:#447fcf">call</span>    <span style="color:#40ffff">qword</span> <span style="color:#40ffff">ptr</span> [<span style="color:#40ffff">rip</span> <span style="color:#a61717;background-color:#e3d2d2">+</span> <span style="color:#40ffff">core</span>::<span style="color:#40ffff">panicking</span>::<span style="color:#40ffff">panic_bounds_check@GOTPCREL</span>]
    <span style="color:#447fcf">ud2</span></code></pre></div>
<p>That is a bit more code than I expected, but a lot of exciting things here! First of all, it seems like the compiler
decided to unroll the loop, cool!</p>

<p>The second thing we can notice is that we don&rsquo;t have checks on the size of the container until we get to the last index of the array the compiler knows to be a valid index. After that, we are going to trigger panic mode. So not as bad as I initially thought.</p>

<p>But this is not an idiomatic use of Rust, in reality Rust prefers you to use iterators on collections, but why would that be the case,
let us find out:</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">loop2</span>(<span style="color:#666"> </span>a: <span style="color:#6ab825">&amp;</span>[<span style="color:#6ab825;font-weight:bold">i32</span>;<span style="color:#3677a9">8</span>])<span style="color:#666"> </span>-&gt; <span style="color:#6ab825;font-weight:bold">i32</span> {<span style="color:#666">
</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">mut</span><span style="color:#666"> </span>total<span style="color:#666"> </span>: <span style="color:#6ab825;font-weight:bold">i32</span> =<span style="color:#3677a9">0</span>;<span style="color:#666">
</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">for</span><span style="color:#666"> </span>var<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">in</span><span style="color:#666"> </span>a.iter()<span style="color:#666">
</span><span style="color:#666">    </span>{<span style="color:#666">
</span><span style="color:#666">        </span>total<span style="color:#666"> </span>+=<span style="color:#666"> </span>var;<span style="color:#666">
</span><span style="color:#666">    </span>}<span style="color:#666">
</span><span style="color:#666">    </span>total<span style="color:#666">
</span><span style="color:#666"></span>}<span style="color:#666">
</span><span style="color:#666"></span></code></pre></div>
<p>Here we are doing the same thing as above, but we are using an iterator, to iterate all the elements. Coming from c++ I am usually
a bit wary of using this kind of loops mostly because I had some terrible experiences with iterators, but that is a different story.
What sort of disassembly did we get?</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">example:<span style="color:#a61717;background-color:#e3d2d2">:</span>loop2:
    <span style="color:#447fcf">movdqu</span>  <span style="color:#40ffff">xmm0</span>, <span style="color:#40ffff">xmmword</span> <span style="color:#40ffff">ptr</span> [<span style="color:#40ffff">rdi</span>]
    <span style="color:#447fcf">movdqu</span>  <span style="color:#40ffff">xmm1</span>, <span style="color:#40ffff">xmmword</span> <span style="color:#40ffff">ptr</span> [<span style="color:#40ffff">rdi</span> <span style="color:#a61717;background-color:#e3d2d2">+</span> <span style="color:#3677a9">16</span>]
    <span style="color:#447fcf">paddd</span>   <span style="color:#40ffff">xmm1</span>, <span style="color:#40ffff">xmm0</span>
    <span style="color:#447fcf">pshufd</span>  <span style="color:#40ffff">xmm0</span>, <span style="color:#40ffff">xmm1</span>, <span style="color:#3677a9">78</span>
    <span style="color:#447fcf">paddd</span>   <span style="color:#40ffff">xmm0</span>, <span style="color:#40ffff">xmm1</span>
    <span style="color:#447fcf">pshufd</span>  <span style="color:#40ffff">xmm1</span>, <span style="color:#40ffff">xmm0</span>, <span style="color:#3677a9">229</span>
    <span style="color:#447fcf">paddd</span>   <span style="color:#40ffff">xmm1</span>, <span style="color:#40ffff">xmm0</span>
    <span style="color:#447fcf">movd</span>    <span style="color:#40ffff">eax</span>, <span style="color:#40ffff">xmm1</span>
    <span style="color:#447fcf">ret</span></code></pre></div>
<p>The above is <strong>completely</strong> different from the code we had before! As a first, we can see the loop has been completely unrolled and also vectorized!</p>

<p>The first three instructions load the ints into 128bits register and do a vectorized add. After that, it will be shuffling the values down to do a 2x wide add and finally the last add with the final value (I am 90% sure about this, I did not go all the way to check the provided masks for the shuffles.</p>

<p>To be fair, that was the best use case since 8 is a multiple of the SIMD register width, what if is not?</p>
<div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">loop3</span>(<span style="color:#666"> </span>a: <span style="color:#6ab825">&amp;</span>[<span style="color:#6ab825;font-weight:bold">i32</span>;<span style="color:#3677a9">5</span>])<span style="color:#666"> </span>-&gt; <span style="color:#6ab825;font-weight:bold">i32</span> {<span style="color:#666">
</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">mut</span><span style="color:#666"> </span>total<span style="color:#666"> </span>: <span style="color:#6ab825;font-weight:bold">i32</span> =<span style="color:#3677a9">0</span>;<span style="color:#666">
</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">for</span><span style="color:#666"> </span>var<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">in</span><span style="color:#666"> </span>a.iter()<span style="color:#666">
</span><span style="color:#666">    </span>{<span style="color:#666">
</span><span style="color:#666">        </span>total<span style="color:#666"> </span>+=<span style="color:#666"> </span>var;<span style="color:#666">
</span><span style="color:#666">    </span>}<span style="color:#666">
</span><span style="color:#666">    </span>total<span style="color:#666">
</span><span style="color:#666"></span>}<span style="color:#666">
</span><span style="color:#666"></span></code></pre></div><div class="highlight"><pre style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">example:<span style="color:#a61717;background-color:#e3d2d2">:</span>loop3:
    <span style="color:#447fcf">movdqu</span>  <span style="color:#40ffff">xmm0</span>, <span style="color:#40ffff">xmmword</span> <span style="color:#40ffff">ptr</span> [<span style="color:#40ffff">rdi</span> <span style="color:#a61717;background-color:#e3d2d2">+</span> <span style="color:#3677a9">4</span>]
    <span style="color:#447fcf">pshufd</span>  <span style="color:#40ffff">xmm1</span>, <span style="color:#40ffff">xmm0</span>, <span style="color:#3677a9">78</span>
    <span style="color:#447fcf">paddd</span>   <span style="color:#40ffff">xmm1</span>, <span style="color:#40ffff">xmm0</span>
    <span style="color:#447fcf">pshufd</span>  <span style="color:#40ffff">xmm0</span>, <span style="color:#40ffff">xmm1</span>, <span style="color:#3677a9">229</span>
    <span style="color:#447fcf">paddd</span>   <span style="color:#40ffff">xmm0</span>, <span style="color:#40ffff">xmm1</span>
    <span style="color:#447fcf">movd</span>    <span style="color:#40ffff">eax</span>, <span style="color:#40ffff">xmm0</span>
    <span style="color:#447fcf">add</span>     <span style="color:#40ffff">eax</span>, <span style="color:#40ffff">dword</span> <span style="color:#40ffff">ptr</span> [<span style="color:#40ffff">rdi</span>]
    <span style="color:#447fcf">ret</span></code></pre></div>
<p>The generated code is quite similar, but the most important thing is there are no range checks, using an iterator the compiler can guarantee there won&rsquo;t be dangerous memory accesses outside the bounds of the array. This leads me to believe you can get into some &ldquo;interesting&rdquo; collections composition/zipping/destructuring that you often find in &ldquo;idiomatic&rdquo; python.</p>

<p>Not sure how I feel about that yet but it seems it would help keep the compiler happy and performances up.</p>

<p>I had quite a bit of fun checking this assembly out and learn lots in how Rust behaves; I will make sure to make another post if I find something interesting! If you liked to feel free to share around.</p>

<p><strong>UPDATES</strong></p>

<p>5/29/2020: Added details on ud2 instruction</p>
 </div>

    
<footer class="post-footer">

  <div class="post-footer-data">
    
<div class="tags">
    
      <div class="tag">
        <a href="/tags/rust">#rust</a>
      </div>
    
      <div class="tag">
        <a href="/tags/disassembly">#disassembly</a>
      </div>
    
</div>

    <div class="date"> May 23, 2020 </div>
  </div>

</footer>


  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "aprogrammerscave" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</article>

  <footer>

  <div class="social-links-footer">

  
  <a href="mailto:myemail"><div class="social-link">Email</div></a>
  

  
  <a href="https://github.com/giordi91" target="_blank"><div class="social-link">GitHub</div></a>
  

  

  
  <a href="https://twitter.com/MGDev91" target="_blank"><div class="social-link">Twitter</div></a>
  

  

  <div class="social-link">
  <a href="/index.xml" target="_blank">RSS</a>
  </div>

</div>


  
<div class="footer-menu">
    
    <a class="footer-menu" href="/comments-policy/">Comments Policy</a>
    
</div>


  <div class="copyright"> Copyright (c) 2018 - present, all rights reserved. </div>

  <div class="poweredby">
    Powered by <a href="https://gohugo.io/">Hugo</a>.
  </div>

  </footer>

</div> 

</body>
</html>

